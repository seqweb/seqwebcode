#!/bin/bash
#
# SeqWeb Bootstrap Script
# 
# This script initializes a SeqWeb development environment by:
# 1. Setting SEQWEBDEV_HOME environment variable
# 2. Creating initial seqweb.conf if none exists
# 3. Creating universal SeqWeb CLI entry point if none exists
# 4. Setting up bash integration
#
# Usage: curl -s https://raw.githubusercontent.com/seqweb/seqwebcode/main/bootstrap | bash
#
# Requirements:
# - Must be run from the intended SeqWeb dev home directory
# - User must have write permissions in the current directory
#

set -e  # Exit on any error

# Save previous value of SEQWEBDEV_HOME if it exists
PREV_SEQWEBDEV_HOME="${SEQWEBDEV_HOME:-}"

# Set SEQWEBDEV_HOME to current directory and export it
export SEQWEBDEV_HOME="$(pwd)"

# Add SeqWeb dev home to PATH for immediate availability
export PATH="$SEQWEBDEV_HOME:$PATH"

echo "Bootstrapping SeqWeb dev home environment in ($SEQWEBDEV_HOME) (was ${PREV_SEQWEBDEV_HOME:-<not set>})"

# Check if seqweb.conf already exists
if [ ! -f "seqweb.conf" ]; then
    echo "Creating initial seqweb.conf configuration file..."
    echo "# SeqWeb Development Configuration" > seqweb.conf
    echo "# This file contains paths to SeqWeb repositories and configuration" >> seqweb.conf
    echo "" >> seqweb.conf
    echo "[repos]" >> seqweb.conf
    echo "seqwebcode=$SEQWEBDEV_HOME/seqwebcode" >> seqweb.conf
    echo "seqweb=$SEQWEBDEV_HOME/seqweb" >> seqweb.conf
    echo "seqwebdata=$SEQWEBDEV_HOME/seqwebdata" >> seqweb.conf
    echo "oeisdata=$SEQWEBDEV_HOME/oeisdata" >> seqweb.conf
    echo "github=$SEQWEBDEV_HOME/.github" >> seqweb.conf
    echo "Created seqweb.conf with default repository paths"
else
    echo "seqweb.conf already exists, skipping creation"
fi

# Check if universal SeqWeb CLI entry point exists
if [ ! -f "seqwebdev" ]; then
    echo "Creating universal SeqWeb CLI entry point..."
    cat > seqwebdev << 'EOF'
#!/bin/bash
# Universal SeqWeb CLI Entry Point
# This script reads seqweb.conf and delegates to the actual SeqWeb CLI implementation

set -e

# Source the configuration
if [ -f "seqweb.conf" ]; then
    # Simple config parsing to get seqwebcode path
    SEQWEBCODE_PATH=$(grep "^seqwebcode=" seqweb.conf | cut -d'=' -f2 | sed 's/\$SEQWEBDEV_HOME/'"$SEQWEBDEV_HOME"'/g')
    
    if [ -n "$SEQWEBCODE_PATH" ] && [ -f "$SEQWEBCODE_PATH/seqwebdev" ]; then
        # Call the actual CLI implementation with all arguments
        exec "$SEQWEBCODE_PATH/seqwebdev" "$@"
    else
        echo "Error: Could not find seqweb SeqWeb CLI implementation at $SEQWEBCODE_PATH/seqwebdev"
        echo "Please ensure seqwebcode repository is cloned and configured correctly"
        echo "See https://www.seqweb.org/quickstart for guidance."
        exit 1
    fi
    else
        echo "Error: seqweb.conf not found in current directory"
        echo "Please run bootstrap script from SeqWeb dev home directory"
        echo "See https://www.seqweb.org/quickstart for guidance."
        exit 1
fi
EOF
    echo "Created universal SeqWeb CLI entry point"
else
    echo "Universal SeqWeb CLI entry point already exists, skipping creation"
fi

# Make the CLI entry point executable
chmod +x seqwebdev

# Detect and modify the appropriate bash file
echo "Detecting bash configuration file..."

# Determine which bash file to use
if [ -f "$HOME/.bashrc" ]; then
    BASH_FILE="$HOME/.bashrc"
elif [ -f "$HOME/.bash_profile" ]; then
    BASH_FILE="$HOME/.bash_profile"
elif [ -f "$HOME/.profile" ]; then
    BASH_FILE="$HOME/.profile"
else
    BASH_FILE="$HOME/.bashrc"
fi

echo "Using bash file: $BASH_FILE"

# Append the export line and alias to the bash file
echo "Appending SeqWeb configuration to $BASH_FILE..."
echo "" >> "$BASH_FILE"
echo "# SeqWeb development environment" >> "$BASH_FILE"
echo "export SEQWEBDEV_HOME=\"$SEQWEBDEV_HOME\"" >> "$BASH_FILE"
echo "export PATH=\"$SEQWEBDEV_HOME:\$PATH\"" >> "$BASH_FILE"

# Source the bash file to make the environment variable and alias available
echo "Sourcing $BASH_FILE to activate environment..."
source "$BASH_FILE"

echo "SEQWEBDEV_HOME is now set to: $SEQWEBDEV_HOME"
echo "seqwebdev command is now available"
echo ""
echo "SeqWeb Bootstrap complete! You can now:"
echo "1. Clone repositories as needed"
echo "2. Edit seqweb.conf if repositories are located elsewhere"
echo "3. Use 'seqwebdev' command to access the CLI"
